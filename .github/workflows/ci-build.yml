name: CI Build

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: nuget restore NetworkWatcherExtension\NetworkWatcherExtension.csproj
      
    - name: Build Extension (Debug)
      run: msbuild NetworkWatcherExtension\NetworkWatcherExtension.csproj /p:Configuration=Debug /p:DeployExtension=false /v:m
      
    - name: Build Extension (Release)
      run: msbuild NetworkWatcherExtension\NetworkWatcherExtension.csproj /p:Configuration=Release /p:DeployExtension=false /p:CreateVsixContainer=true /v:m
      
    - name: Find VSIX file
      id: find_vsix
      shell: pwsh
      run: |
        Write-Host "=== Searching for VSIX file ==="
        Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Recurse | Where-Object { $_.Extension -eq ".vsix" -or $_.Extension -eq ".dll" } | Format-Table FullName, Length

        $vsixFile = Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Filter "*.vsix" -Recurse | Select-Object -First 1
        if ($vsixFile) {
          echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "VSIX_NAME=$($vsixFile.Name)" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… Build successful: $($vsixFile.Name)"
          Write-Host "ðŸ“¦ Size: $([math]::Round($vsixFile.Length / 1MB, 2)) MB"
        } else {
          Write-Host "âŒ VSIX file not found in bin\Release"
          Write-Host "Searching entire bin directory:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin" -Filter "*.vsix" -Recurse | Format-Table FullName
          exit 1
        }
    
    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetworkWatcher-VSIX-${{ github.sha }}
        path: ${{ steps.find_vsix.outputs.VSIX_PATH }}
        retention-days: 30

    - name: Create Build Artifacts Package
      shell: pwsh
      run: |
        Write-Host "=== Creating build artifacts package ==="

        $outputDir = "NetworkWatcher-Build-Artifacts"
        New-Item -ItemType Directory -Force -Path $outputDir | Out-Null

        $releaseDir = "NetworkWatcherExtension\bin\Release"
        Get-ChildItem -Path $releaseDir -Recurse | Where-Object { 
          $_.Extension -in @('.dll', '.pdb', '.xml', '.json') -and 
          -not $_.FullName.Contains('obj') 
        } | ForEach-Object {
          $relativePath = $_.FullName.Substring((Resolve-Path $releaseDir).Path.Length + 1)
          $targetPath = Join-Path $outputDir $relativePath
          $targetDir = Split-Path $targetPath -Parent

          if (-not (Test-Path $targetDir)) {
            New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          }

          Copy-Item $_.FullName -Destination $targetPath
        }

        $zipPath = "NetworkWatcher-Build-Artifacts.zip"
        Compress-Archive -Path "$outputDir\*" -DestinationPath $zipPath -Force

        Write-Host "âœ… Created build artifacts ZIP"
        Write-Host "ðŸ“¦ Size: $([math]::Round((Get-Item $zipPath).Length / 1MB, 2)) MB"

        echo "BUILD_ZIP_PATH=$zipPath" >> $env:GITHUB_OUTPUT
      id: create_build_package

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NetworkWatcher-Build-${{ github.sha }}
        path: ${{ steps.create_build_package.outputs.BUILD_ZIP_PATH }}
        retention-days: 30

