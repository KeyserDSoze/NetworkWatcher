name: Build and Release VSIX

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Setup Visual Studio SDK
      shell: pwsh
      run: |
        Write-Host "=== Checking Visual Studio SDK ==="
        $vsPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise"
        if (-not (Test-Path $vsPath)) {
          $vsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise"
        }
        if (Test-Path $vsPath) {
          Write-Host "âœ… Visual Studio found at: $vsPath"
        } else {
          Write-Host "âš ï¸ Visual Studio path not found, relying on MSBuild"
        }
        Write-Host "VSToolsPath environment variable:"
        Write-Host $env:VSToolsPath

    - name: Restore NuGet packages
      run: nuget restore NetworkWatcherExtension\NetworkWatcherExtension.csproj

    - name: Update VSIX Version from Tag
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        Write-Host "=== Updating VSIX version from Git tag ==="

        # Extract version from tag (e.g., v1.2.3 -> 1.2.3)
        $tagName = "${{ github.ref_name }}"
        Write-Host "Git tag: $tagName"

        if ($tagName -match '^v?(\d+\.\d+\.\d+)') {
          $version = $matches[1]
          Write-Host "Extracted version: $version"

          # Update source.extension.vsixmanifest
          $manifestPath = "NetworkWatcherExtension\source.extension.vsixmanifest"
          $manifest = Get-Content $manifestPath -Raw

          # Replace version in Identity element
          $manifest = $manifest -replace '(<Identity[^>]+Version=")[^"]+(")', "`${1}$version`$2"

          Set-Content $manifestPath -Value $manifest -NoNewline

          Write-Host "âœ… Updated manifest version to: $version"

          # Show the change
          Write-Host "Updated line:"
          Get-Content $manifestPath | Select-String "Version="
        } else {
          Write-Host "âš ï¸ Tag format not recognized. Expected: v1.2.3"
          Write-Host "Using existing version in manifest"
        }

    - name: Build VSIX
      run: msbuild NetworkWatcherExtension\NetworkWatcherExtension.csproj /p:Configuration=Release /p:DeployExtension=false /p:CreateVsixContainer=true /p:ZipPackageCompressionLevel=normal /v:m

    - name: Verify Build Output
      shell: pwsh
      run: |
        Write-Host "=== Verifying build output ==="
        if (Test-Path "NetworkWatcherExtension\bin\Release") {
          Write-Host "âœ… Release folder exists"
          Write-Host "Contents:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" | Format-Table Name, Length
        } else {
          Write-Host "âŒ Release folder not found!"
          Write-Host "Available folders:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin" | Format-Table Name
          exit 1
        }

    - name: Find VSIX file
      id: find_vsix
      shell: pwsh
      run: |
        Write-Host "=== Searching for VSIX file ==="
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Listing bin\Release contents:"
        Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Recurse | Format-Table FullName, Length

        $vsixFile = Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Filter "*.vsix" -Recurse | Select-Object -First 1
        if ($vsixFile) {
          echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "VSIX_NAME=$($vsixFile.Name)" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… Found VSIX: $($vsixFile.FullName)"
          Write-Host "   Size: $([math]::Round($vsixFile.Length / 1MB, 2)) MB"
        } else {
          Write-Host "âŒ VSIX file not found in NetworkWatcherExtension\bin\Release"
          Write-Host "Searching in entire bin directory:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin" -Filter "*.vsix" -Recurse | Format-Table FullName
          exit 1
        }

    - name: Verify VSIX Version
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        Write-Host "=== Verifying VSIX version ==="

        $vsixPath = "${{ steps.find_vsix.outputs.VSIX_PATH }}"
        $tagName = "${{ github.ref_name }}"

        # Extract version from tag
        if ($tagName -match '^v?(\d+\.\d+\.\d+)') {
          $expectedVersion = $matches[1]

          # Read manifest to verify version
          $manifestPath = "NetworkWatcherExtension\source.extension.vsixmanifest"
          $manifestContent = Get-Content $manifestPath -Raw

          if ($manifestContent -match 'Version="([^"]+)"') {
            $actualVersion = $matches[1]
            Write-Host "Tag version: $expectedVersion"
            Write-Host "VSIX version: $actualVersion"

            if ($expectedVersion -eq $actualVersion) {
              Write-Host "âœ… Version match confirmed!"
            } else {
              Write-Host "âš ï¸ Version mismatch detected!"
              Write-Host "   Tag: v$expectedVersion"
              Write-Host "   VSIX: $actualVersion"
            }
          }
        }

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetworkWatcher-VSIX
        path: ${{ steps.find_vsix.outputs.VSIX_PATH }}
        retention-days: 90

    - name: Create Build Artifacts Package
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        Write-Host "=== Creating build artifacts package ==="

        # Create output directory
        $outputDir = "NetworkWatcher-Build-Artifacts"
        New-Item -ItemType Directory -Force -Path $outputDir

        # Copy binaries (including VSIX)
        $releaseDir = "NetworkWatcherExtension\bin\Release"
        Get-ChildItem -Path $releaseDir -Recurse | Where-Object { 
          $_.Extension -in @('.dll', '.pdb', '.xml', '.json', '.vsix') -and 
          -not $_.FullName.Contains('obj') 
        } | ForEach-Object {
          $relativePath = $_.FullName.Substring((Resolve-Path $releaseDir).Path.Length + 1)
          $targetPath = Join-Path $outputDir $relativePath
          $targetDir = Split-Path $targetPath -Parent

          if (-not (Test-Path $targetDir)) {
            New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          }

          Copy-Item $_.FullName -Destination $targetPath
          Write-Host "Copied: $relativePath"
        }

        # Create ZIP
        $zipPath = "NetworkWatcher-Build-Artifacts.zip"
        Compress-Archive -Path "$outputDir\*" -DestinationPath $zipPath -Force

        $zipSize = (Get-Item $zipPath).Length
        Write-Host "âœ… Created build artifacts ZIP: $zipPath"
        Write-Host "ğŸ“¦ Size: $([math]::Round($zipSize / 1MB, 2)) MB"

        echo "BUILD_ZIP_PATH=$zipPath" >> $env:GITHUB_OUTPUT
        echo "BUILD_ZIP_NAME=NetworkWatcher-Build-Artifacts.zip" >> $env:GITHUB_OUTPUT
      id: create_build_package

    - name: Upload Build Artifacts
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: NetworkWatcher-Build-Artifacts
        path: ${{ steps.create_build_package.outputs.BUILD_ZIP_PATH }}
        retention-days: 90

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.find_vsix.outputs.VSIX_PATH }}
          ${{ steps.create_build_package.outputs.BUILD_ZIP_PATH }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ Network Watcher Extension Release

          ### ğŸ“¦ Downloads

          - **NetworkWatcherExtension.vsix** - Visual Studio Extension (standalone installer)
          - **NetworkWatcher-Build-Artifacts.zip** - Complete package (VSIX + all binaries, PDBs, symbols)

          ### Installation

          #### Quick Install (Most Users):
          1. Download the **`.vsix`** file below
          2. Close all Visual Studio instances
          3. Double-click the `.vsix` file to install
          4. Restart Visual Studio
          5. Open **View â†’ Other Windows â†’ Network Watcher**

          #### Complete Package (Developers/Debugging):
          1. Download the **`Build-Artifacts.zip`** file
          2. Extract to see:
             - VSIX file (for installation)
             - Compiled DLLs (for referencing)
             - PDB files (for debugging with symbols)
             - XML docs (for IntelliSense)
          3. Use PDB files for debugging with full source line numbers

          ### Features
          - ğŸŒ HTTP/HTTPS traffic monitoring
          - ğŸ” Request/Response inspection
          - ğŸ¨ JSON prettification
          - ğŸ” Search functionality with highlighting
          - ğŸŒ™ Dark theme optimized UI

          ### Requirements
          - Visual Studio 2022 or later
          - .NET Framework 4.7.2 or later
          - ğŸ” Request/Response inspection
          - ğŸ¨ JSON prettification
          - ğŸ” Search functionality with highlighting
          - ğŸŒ™ Dark theme optimized UI
          
          ### Requirements
          - Visual Studio 2022 or later
          - .NET Framework 4.7.2 or later
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
