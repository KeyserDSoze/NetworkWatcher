name: Build and Release VSIX

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Setup Visual Studio SDK
      shell: pwsh
      run: |
        Write-Host "=== Checking Visual Studio SDK ==="
        $vsPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise"
        if (-not (Test-Path $vsPath)) {
          $vsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise"
        }
        if (Test-Path $vsPath) {
          Write-Host "âœ… Visual Studio found at: $vsPath"
        } else {
          Write-Host "âš ï¸ Visual Studio path not found, relying on MSBuild"
        }
        Write-Host "VSToolsPath environment variable:"
        Write-Host $env:VSToolsPath

    - name: Restore NuGet packages
      run: nuget restore NetworkWatcherExtension\NetworkWatcherExtension.csproj
      
    - name: Build VSIX
      run: msbuild NetworkWatcherExtension\NetworkWatcherExtension.csproj /p:Configuration=Release /p:DeployExtension=false /p:CreateVsixContainer=true /p:ZipPackageCompressionLevel=normal /v:m

    - name: Verify Build Output
      shell: pwsh
      run: |
        Write-Host "=== Verifying build output ==="
        if (Test-Path "NetworkWatcherExtension\bin\Release") {
          Write-Host "âœ… Release folder exists"
          Write-Host "Contents:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" | Format-Table Name, Length
        } else {
          Write-Host "âŒ Release folder not found!"
          Write-Host "Available folders:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin" | Format-Table Name
          exit 1
        }

    - name: Find VSIX file
      id: find_vsix
      shell: pwsh
      run: |
        Write-Host "=== Searching for VSIX file ==="
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Listing bin\Release contents:"
        Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Recurse | Format-Table FullName, Length

        $vsixFile = Get-ChildItem -Path "NetworkWatcherExtension\bin\Release" -Filter "*.vsix" -Recurse | Select-Object -First 1
        if ($vsixFile) {
          echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "VSIX_NAME=$($vsixFile.Name)" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… Found VSIX: $($vsixFile.FullName)"
          Write-Host "   Size: $([math]::Round($vsixFile.Length / 1MB, 2)) MB"
        } else {
          Write-Host "âŒ VSIX file not found in NetworkWatcherExtension\bin\Release"
          Write-Host "Searching in entire bin directory:"
          Get-ChildItem -Path "NetworkWatcherExtension\bin" -Filter "*.vsix" -Recurse | Format-Table FullName
          exit 1
        }
    
    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetworkWatcher-VSIX
        path: ${{ steps.find_vsix.outputs.VSIX_PATH }}
        retention-days: 90
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.find_vsix.outputs.VSIX_PATH }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ Network Watcher Extension Release
          
          ### Installation
          1. Download the `.vsix` file below
          2. Close all Visual Studio instances
          3. Double-click the `.vsix` file to install
          4. Restart Visual Studio
          5. Open **View â†’ Other Windows â†’ Network Watcher**
          
          ### Features
          - ğŸŒ HTTP/HTTPS traffic monitoring
          - ğŸ” Request/Response inspection
          - ğŸ¨ JSON prettification
          - ğŸ” Search functionality with highlighting
          - ğŸŒ™ Dark theme optimized UI
          
          ### Requirements
          - Visual Studio 2022 or later
          - .NET Framework 4.7.2 or later
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
